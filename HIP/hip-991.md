---
hip: 991
title: Permissionless revenue-generating Topic Ids for Topic Operators
author: Michael Kantor (@kantorcodes), Ty Smith (@ty-swirldslabs)
requested-by: TierBot
type: Standards Track
category: Core
needs-council-approval: Yes
status: Council Review
last-call-date-time: 2024-07-24T07:00:00Z
created: 2024-06-14
discussions-to: https://github.com/hashgraph/hedera-improvement-proposal/pull/991
updated: 2024-07-30
---

## Abstract

This document outlines the development of a fixed fee system for the submission of topic messages on the Hedera network. It addresses the need for improved economic scalability and aims to enhance resource allocation and revenue distribution mechanisms for topic operators. It also seeks to simplify engineering complexity for dApp developers on the Hedera network.

## Background and Motivation

**Problems to Solve:**

* **Dynamic Restriction of Access to Topic Writing:** Users currently face difficulties when creating new topic IDs because they must choose between making the topic publicly writable for a very low cost or implementing a complex web architecture to manage access through the submit key. This complexity can hinder user experience and development efficiency.
* **Ease of Monetization:** Developers and businesses find it challenging to charge users for submitting information to a topic due to the lack of a native fee structure. A built-in payment system would streamline monetization, allowing developers to easily charge for topic submissions, which can enhance the financial viability of their applications.
* **Resource Allocation:** The current low fee of $0.0001 per message makes it difficult for topic operators to manage and predict the economic impact of high-traffic topics. Users can suffer from spam and unexpected messages that operators have to handle, potentially degrading the quality of service.
* **Token and HBAR Utilization:** There is an opportunity to expand the utility of various tokens within the Hedera ecosystem. By allowing fees to be paid in tokens other than HBAR, such as those required by DAOs, users can leverage their token holdings for topic submissions, enhancing the ecosystem's flexibility and user engagement.

**Feature Summary:**

* HCS topics can have an optional fee for submitting messages. Fees can be set in HBAR or HTS fungible tokens.
* HCS topics have now a new Fee Schedule Key. This key can manage fee updates and send free messages to the topic. The key can be set at creation time and updated later (similarly to HTS tokens). If the HCS topic was created without a Fee Schedule Key, it cannot be added later.
* Topic fees can be distributed similarly to fixed fees on the HTS, supporting multiple wallets, percentage distributions, and Fungible tokens in addition to HBAR.
* Security measures to prevent unauthorized access to fee configurations and distributions.
* Security measures to prevent users from being induced to pay unforeseen charges.
* Distribution of collected fees akin to fixed fees on tokens, with support for distribution to multiple account IDs.

**Benefits:**

* Provides predictable revenue per message for topic operators.
* Enables new products and business models on HCS.
* Increases node revenue for network fees tied to new HCS transactions/topic creations with fixed fees.
* Enhances the utility of HCS within Hedera.
* Increases revenue streams for node operators.
* Enables simple facilitation of holding and spending tokens to document new information on a topic.

**Related Requests:**

This enhancement is in response to community feedback (Tier Bot) requesting more versatile and predictable economic models within topic IDs on the Hedera network.

## User personas and stories

**User Personas:**

* **Topic Operator:** Entities or individuals who manage and operate topics, interested in stable revenue and easy management of topic-related transactions.
* **Topic Operator:** Entities or individuals who manage and operate topics, interested in reducing the noise of public topic IDs/making it more difficult to spam an open topic.
* **Regular User:** End users who interact with topics, adding paid methods of interaction and submission to topics.

**User Stories:**

* As a **Topic Operator**, I want to set a fixed fee for submitting messages to my topic, so that I can ensure a consistent revenue stream and manage my topic effectively.
* As a **Regular User**, I want to know the exact cost of interacting with a topic.

## Specification

### Overview

We propose adding a fixed fee mechanism to the Hedera Consensus Service (HCS) for topic messages, similar to the custom fee structures in the Hedera Token Service (HTS). This will involve creating new protocol buffers (protobuf) messages and modifying existing ones to accommodate fixed fees for topics.

### Requirements and Scope

* Topics can have a Fee Schedule Key set at creation time.
* Fee Schedule Key can manage fee updates and send free messages to the topic.
* The Fee Schedule Key can be updated with an update topic transaction signed by the Admin Key and the new Fee Schedule Key.
* If the topic was created without a Fee Schedule Key, the key cannot be added later.
* Topics can have fees for submitting messages.
* Fees can be set at creation time.
* Fees can be changed (updated or removed) from a topic with an update topic transaction signed by the Fee Schedule Key.
* Fees are defined as a list of custom fee.
* A custom fee can be set in HBAR or HTS fungible tokens, and must have an accountID as a receiver.
* Fee payer must set an allowance in HBAR or HTS tokens to be used to pay fees for message submissions, on an HCS topic basis.
* Allowance granted to topic ID does not allow the topic's Admin Key (or any of the topic's keys) to spend that allowance.
* Fee payer must set can set a maximum fee per message, on an HCS topic basis.
* Messages signed by the Fee Schedule Key or by a Submit Key don't incur fees.
* Applications must set the `allowCustomFeesPayment` flag to true.
* Default value of the `allowCustomFeesPayment` flag is false.
* If the `allowCustomFeesPayment` flag is not set, or is not true, a transaction error will be fired.

### User Flows and Interaction

* Users will specify the fee settings during the topic creation process through a simple interface in their Hedera client (refer to the creation of token custom fees/fixed fee for reference).
* Before submitting a message to a topic through an application or wallet interface, users must set an allowance and a maximum fee per message.
* In case of user wallets, applications show the custom fees to the user before submitting the message.
* Operators will get fee collections and distributions automatically through the custom fees just like they do in the token service currently.

### New and Modified Protobuf Messages

The following is a list of suggested modifications to the protobuf messages structure to comply with the above requirements.

#### ConsensusCustomFee

The `ConsensusCustomFee` message defines the type of fee and the account ID receiving the fee assessed during a message submission to the associated topic. A custom fee may only be a `FixedFee` and must specify a fee collector account to receive the assessed fees. `FixedFee` is an existing protobuf message and it must not be modified.

```protobuf
message ConsensusCustomFee {
  /**
  * Fixed fee to be charged
  */
  FixedFee fixed_fee = 1;

  /**
  * The account to receive the custom fee
  */
  AccountID fee_collector_account_id = 2;
}
```

#### ConsensusCreateTopicTransactionBody

The `ConsensusCreateTopicTransactionBody` message is updated to include the optional Fee Schedule Key and `custom_fees` property for specifying fixed fees during topic creation.

```protobuf
message ConsensusCreateTopicTransactionBody {
  [...]

  /**
    * Access control for update/delete of custom fees. Null if there is no key.
    */
  Key fee_schedule_key = 8;

  /**
    * The custom fee to be assessed during a message submission to this topic
    */
  repeated ConsensusCustomFee custom_fees = 9;
}
```

#### ConsensusUpdateTopicTransactionBody

The `ConsensusUpdateTopicTransactionBody` message is updated to include the optional Fee Schedule Key and `custom_fees` property for specifying fixed fees during topic creation.

```protobuf
message ConsensusUpdateTopicTransactionBody {
  [..]
  /**
    * Access control for update/delete of custom fees. Null if there is no key.
    */
  Key fee_schedule_key = 10;

  /*
   * The custom fee to be assessed during a message submission to this topic
   */
  repeated ConsensusCustomFee custom_fees = 11;
}
```

#### ConsensusTopicInfo

The `ConsensusTopicInfo` message is updated to include the Fee Schedule Key and the current list of custom fixed fees associated with the topic.

```protobuf
message ConsensusTopicInfo {
  [...]
  /**
    * Access control for update/delete of custom fees. Null if there is no key.
    */
  Key fee_schedule_key = 10;

  /*
   * The custom fee to be assessed during a message submission to this topic
   */
  repeated ConsensusCustomFee custom_fees = 11;
}
```

#### ConsensusSubmitMessageTransactionBody

The `ConsensusSubmitMessageTransactionBody` message is updated to include the `allowCustomFeesPayment` flag.

```protobuf
message ConsensusSubmitMessageTransactionBody {
  [...]

  /**
    * Flag to allow custom fee payment for this transaction. Default is false.
    */
  bool allow_custom_fees_payment = 4;
}
```

#### CryptoApproveAllowanceTransactionBody

The `CryptoApproveAllowanceTransactionBody` message is updated to include one or more `ConsensusCryptoFeeScheduleAllowance` and one or more `ConsensusTokenFeeScheduleAllowance` messages.

```protobuf
message CryptoApproveAllowanceTransactionBody {
  [...]
  /**
   * List of hbar allowances approved by the account owner.
   */
  repeated ConsensusCryptoFeeScheduleAllowance consensus_crypto_fee_schedule_allowances = 4;

  /**
   * List of fungible token allowances approved by the account owner.
   */
  repeated ConsensusTokenFeeScheduleAllowance consensus_token_fee_schedule_allowances = 5;
}
```

#### ConsensusCryptoFeeScheduleAllowance

This is a new protobuf message definition to enable crypto allowance for topics.

```protobuf
/**
 * An approved allowance of hbar transfers for a spender.
 */
message ConsensusCryptoFeeScheduleAllowance {
  /**
   * The account ID of the hbar owner (ie. the grantor of the allowance).
   */
  AccountID owner = 1;

  /**
   * The topic ID enabled to spend fees from the hbar allowance.
   */
  TopicID spender = 2;

  /**
   * The amount of the spender's allowance in tinybars.
   */
  int64 amount = 3;

  /**
   * The maximum amount of the spender's token allowance per message.
   */
  int64 amount_per_message = 4;
}
```

#### ConsensusTokenFeeScheduleAllowance

This is a new protobuf message definition to enable token allowance for topics.

```protobuf
/**
 * An approved allowance of fungible token transfers for a spender.
 */
message ConsensusTokenFeeScheduleAllowance {
  /**
   * The token that the allowance pertains to.
   */
  TokenID tokenId = 1;

  /**
   * The account ID of the token owner (ie. the grantor of the allowance).
   */
  AccountID owner = 2;

  /**
   * The topic ID enabled to spend fees from the token allowance.
   */
  TopicID spender = 3;

  /**
   * The maximum amount of the spender's token allowance.
   */
  int64 amount = 4;

  /**
   * The maximum amount of the spender's token allowance per message.
   */
  int64 amount_per_message = 5;
}
```

### SDKs and Mirror Node services

This document does not contain the details about the implementation updates required by the SDKs and the Mirror Node to comply with the HIP-991 specifications. A suggested example for the JavaScript SDK is described in the [Reference Implementation](#reference-implementation) section.

## Backwards Compatibility

The HIP introduces new features while ensuring compatibility and integration with existing Hedera network protocols and services.
New topics with custom fees will require appropriate updates to the Hedera SDKs, mirror nodes, and applications to support the new fee structures.
There are no known backward compatibility issues. Existing topics without custom fees will continue to function as they currently do.

## Security Implications

The introduction of custom fees adds an additional layer of economic control but also introduces potential vectors for abuse, such as fee manipulation. To address these issues, this HIP complies with the current security requirements regarding allowance for moving user's funds. In particular, before being able to send paid HCS messages to a topic, the users should previously set an allowance for the recipient topic, the same way they do in the case of HTS, to allow paying for fixed or custom fees. The user can also set a maximum fee per message. The default value for both parameters is 0.

## How to Teach This

TBD

## Reference Implementation

Below is a pseudo-code example of creating a topic with a fixed fee, setting the allowance, and sending a message.

```JavaScript
// Create the Hedera client
const client = Client.forTestnet();

// Define the submit key
const submitKey = PrivateKey.generate();

// Define the fee collector account ID
const feeCollectorAccountId = AccountId.fromString("0.0.12345");

// Define the fixed fee
const topicCustomFee = new TopicCustomFee()
  .setAmount(100) // 100 tokens are transferred to the fee collecting account each time this token is transferred
  .setDenominatingTokenId(TokenId.fromString("0.0.56789")) // // The token to charge the fee in. HBAR if unset
  .setFeeCollectorAccountId(feeCollectorAccountId); // 100 tokens are sent to this account for each HCS message to the topic

// Create the topic with the custom fee
const transactionResponse = await new TopicCreateTransaction()
  .setTopicMemo("Example Topic with Fixed Fee")
  .setTopicCustomFees([topicCustomFee]) // List of custom fees. In this example, a single fixed fee in tokens
  .execute(client);

// Request the receipt of the transaction
const receipt = await transactionResponse.getReceipt(client);
console.log(`Created topic with ID: ${receipt.topicId}`);

[...]

// Set allowance
const spenderTopicId = new TopicID("0.0.54321")
transactionResponse = new TopicAllowanceApproveTransaction()
    .approveHbarAllowance(ownerAccount, spenderTopicId, Hbar.from(100), Hbar.from(2)); // Set owner, topicId, maximum allowance, and max per message
    
[...]

// Send message to the topic
transactionResponse = await new TopicMessageSubmitTransaction({ topicId: topicId, message: "Hello, HCS!" })
  .setAllowCustomFeesPayment(true) // Make the agreement on payment explicit at the application level. Useful for any backend / non-front-user-facing application.
  .execute(client);

```

This implementation shows the creation of a topic where each message submission requires a fixed fee of 100 tokens with ID 0.0.56789, collected by the specified account.

## Rejected Ideas

N/A

## References

* [Authoritative source of Hedera protobufs](https://github.com/hashgraph/hedera-protobufs)

## Copyright/license

This document is licensed under the Apache License, Version 2.0 -- see [LICENSE](../LICENSE) or (<https://www.apache.org/licenses/LICENSE-2.0>)
